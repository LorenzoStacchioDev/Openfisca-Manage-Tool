#:kivy 1.10.0
#: import FadeTransition kivy.uix.screenmanager.FadeTransition
#: import hex kivy.utils.get_color_from_hex
#: import utils kivy.utils

<MyScreenManager>:
    transition: FadeTransition()
    InitScreen:
    HomeScreen:
    ChooseEntityScreen:
    VisualizeSystemScreen:
    MakeSimulation:
    OutputVariableScreen:
    ReformsScreen:
    ExecuteSimulationScreen:
    SelectVariableScreen:
    FormVariableScreen:

<InitScreen>:
    name: "init"
    PageLayout:
        id: page_layout_init_screen
        orientation: 'vertical'
        GridLayout:
            id: grid_layout_init
            cols: 1
            rows: 3
            Label:
                id: lbl_txt_1
                valign: 'middle'
                halign: 'center'
                size_hint: (1.0,0.33)
                font_size: 30
                markup: True
                text: "You have to select on of the following system.\n The white ones are available,\n instead the red ones aren't installed yet.\n To install a system, swap page!"
                size: self.texture_size
                canvas.before:
                    Color:
                        rgba: hex('#971640')
                    Rectangle:
                        pos: self.pos
                        size: self.size
            GridLayout:
                cols: 5
                rows: 2
                id: home_system_chooser
                canvas.before:
                    Color:
                        rgba: hex('#ff0000')
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Button:
                    background_normal: "ffffff"
                    disabled: True
                    id: openfisca-france
                    Image:
                        source: 'img/openfisca_system/openfisca-france.png'
                        pos: self.parent.pos
                        size: self.parent.size
                Button:
                    disabled: True
                    background_normal: "ffffff"
                    id: openfisca-italy
                    Image:
                        source: 'img/openfisca_system/openfisca-italy.png'
                        pos: self.parent.pos
                        size: self.parent.size
                Button:
                    disabled: True
                    background_normal: "ffffff"
                    id: openfisca-barcelona
                    canvas:
                        Color:
                            rgb: 1, 0, 0
                    Image:
                        source: 'img/openfisca_system/openfisca-barcelona.png'
                        pos: self.parent.pos
                        size: self.parent.size
                Button:
                    disabled: True
                    background_normal: "ffffff"
                    id: senegal
                    Image:
                        source: 'img/openfisca_system/openfisca-senegal.png'
                        pos: self.parent.pos
                        size: self.parent.size
                Button:
                    disabled: True
                    id: openfisca-tunisia
                    background_normal: "ffffff"
                    Image:
                        source: 'img/openfisca_system/openfisca-tunisia.png'
                        pos: self.parent.pos
                        size: self.parent.size


        GridLayout:
            cols: 1
            rows: 5
            Label:
                canvas.before:
                    Color:
                        rgba: hex('#FFFFFF')
                    Rectangle:
                        pos: self.pos
                        size: self.size

            FloatLayout:
                pos: self.parent.pos
                size: self.parent.size
                orientation: "horizontal"
                Label:
                    pos: self.parent.pos
                    text: ""
                    canvas.before:
                        Color:
                            rgba: hex('#FFFFFF')
                        Rectangle:
                            pos: self.pos
                            size: self.size
                GridLayout:
                    pos: self.parent.pos
                    size: self.parent.size
                    rows: 1
                    cols: 2
                    Image:
                        source: 'img/openfisca.png'
                    Image:
                        source: 'img/github.png'

            Label:
                id: instructions_downloading_repos
                markup: True
                text: root.download_information
                canvas.before:
                    Color:
                        rgba: hex('#FFFFFF')
                    Rectangle:
                        pos: self.pos
                        size: self.size

            GridLayout:
                id: grid_layout_countries
                pos: self.parent.pos
                size: self.parent.size
                cols: 3
                Button:
                    id: button_france
                    background_normal: "ffffff"
                    on_release: root.download_system(self)
                    Image:
                        source: 'img/flags/france-flag.png'
                        pos: self.parent.pos
                        size: self.parent.size

                Button:
                    id: button_barcelona
                    background_normal: "ffffff"
                    on_release: root.download_system(self)
                    Image:
                        source: 'img/flags/spain-flag.png'
                        pos: self.parent.pos
                        size: self.parent.size

                Button:
                    id: button_italy
                    background_normal: "ffffff"
                    on_release: root.download_system(self)
                    Image:
                        source: 'img/flags/italy-flag.png'
                        pos: self.parent.pos
                        size: self.parent.size

                Label:
                    canvas.before:
                        Color:
                            rgba: hex('#FFFFFF')
                        Rectangle:
                            pos: self.pos
                            size: self.size
                Label:
                    canvas.before:
                        Color:
                            rgba: hex('#FFFFFF')
                        Rectangle:
                            pos: self.pos
                            size: self.size
                Label:
                    canvas.before:
                        Color:
                            rgba: hex('#FFFFFF')
                        Rectangle:
                            pos: self.pos
                            size: self.size

                Button:
                    id: button_senegal
                    background_normal: "ffffff"
                    on_release: root.download_system(self)
                    Image:
                        source: 'img/flags/senegal-flag.png'
                        pos: self.parent.pos
                        size: self.parent.size
                Button:
                    id: button_tunisia
                    background_normal: "ffffff"
                    on_release: root.download_system(self)
                    Image:
                        source: 'img/flags/tunisia-flag.jpg'
                        pos: self.parent.pos
                        size: self.parent.size
                Button:
                    id: empty_button
                    background_normal: "ffffff"

            Label:
                canvas.before:
                    Color:
                        rgba: hex('#FFFFFF')
                    Rectangle:
                        pos: self.pos
                        size: self.size

<HomeScreen>:
    name: "home"
    BoxLayout:
        id: boxlayout_home
        orientation: 'vertical'
        rows: 3
        canvas.before:
            Color:
                rgba: hex('ffffff')
            Rectangle:
                pos: self.pos
                size: self.size
        Label:
            id: label_0_0
            size_hint_y: None
            valign: 'middle'
            text_size: self.width, None
            height: self.texture_size[1]
            padding_x: 50
            markup: True
            #canvas.before:
            #    Rectangle:
            #        pos: self.center_x, self.center_y # default size is 100x100
            #        source: 'img\law.png'
        BoxLayout:
            id: boxlayout_image
            orientation: 'horizontal'
            Image:
                source: 'img\logo.png'



        BoxLayout:
            id: boxlayout_withbuttons
            orientation: 'horizontal'

            Button:
                id: btn_1_0
                valign: 'middle'
                halign: 'center'
                markup: True
                background_color: hex('971640')
                font_size: "18sp"
                size_hint: .4, .3
                text: "Visualize the tax\nand benefit system"
                on_press: root.go_to_visualize()
                canvas.before:
                    #Color:
                        #rgba: hex('')
                    Rectangle:
                        pos: self.pos
                        size: self.size
            Button:
                id: btn_0_1
                valign: 'middle'
                halign: 'center'
                background_color: hex('971640')
                font_size: "18sp"
                size_hint: .4, .3
                markup: True
                text: "Do some reforms"
                on_press: root.go_to_reforms()
                canvas.before:
                    Rectangle:
                        pos: self.pos
                        size: self.size

            Button:
                id: btn_1_2
                valign: 'middle'
                halign: 'center'
                background_color: hex('971640')
                font_size: "18sp"
                size_hint: .4, .3
                markup: True
                text: "Make a [b]simulation[/b]!"
                on_press: root.go_to_simulation()
                canvas.before:
                    Rectangle:
                        pos: self.pos
                        size: self.size


<ChooseEntityScreen>:
    name: "choose_entity"
    canvas.before:
        Color:
            rgba: 1, 1, 1, 1
        Rectangle:
            pos: self.pos
            size: self.size

<LineOfChooser>:
    name: "line_chooser"
    Label:
        id: name
        size_hint: (0.3,1.0)
        color: 0,0,0,1
        font_size: "20sp"
        markup: True
    Label:
        id: value
        text: "0"
        size_hint: (0.3,1.0)
        color: 0,0,0,1
        font_size: "20sp"
    Button:
        id: dec
        text: "<"
        font_size: 20
        on_release: root.decrementa()
        background_color: hex('971640')
        size_hint: (0.3,1.0)
    Button:
        id: inc
        text: ">"
        font_size: 20
        on_release: root.incrementa()
        background_color: hex('971640')
        size_hint: (0.3,1.0)

<VisualizeSystemScreen>:
    name: "visualize_system"
    fullscreen: True
    on_parent: if args[1] and switch_object_visualize.current_tab == tabbed_variables: root.show_variables()

    TabbedPanel:
        id: switch_object_visualize
        do_default_tab: False
        #pos_hint: {'center_x': .5, 'center_y': .5}
        canvas.before:
            Color:
                rgb: hex("9C2542")
            Rectangle:
                pos: self.pos
                size: self.size
        TabbedPanelItem:
            id: tabbed_variables
            text: 'Variables'
            on_release: root.show_variables()
            background_color: (1, 0, 0, .5)
            BoxLayout:
                id: box_variables
                orientation: 'vertical'
                canvas.before:
                    Color:
                        rgb: hex("771C33")
                    Rectangle:
                        pos: self.pos
                        size: self.size
                BoxLayout:
                    id: box_variables_inner
                    orientation: 'horizontal'
                    size_hint: (1.0,0.95)
                    FileChooserListView:
                        id: visualize_file_chooser_variables
                        size_hint: (0.70,1.0)
                        filter_dirs: True
                        filters: [root.file_allowed]
                        on_selection: root.selected_file(*args)
                    RstDocument:
                        id: document_variables_viewer

                GridLayout:
                    rows: 1
                    cols: 2
                    size_hint: (1.0,0.05)
                    Label:
                        id: current_path_variables
                        valign: 'middle'
                        halign: 'center'
                    Button:
                        id: back_home
                        size_hint: (0.3,1.0)
                        on_press: root.go_to_home()
                        text: 'Come back to home'
                        background_color: hex('971640')

        TabbedPanelItem:
            id: tabbed_parameters
            text: 'Parameters'
            on_release: root.show_parameters()
            background_color: (1, 0, 0, .5)
            BoxLayout:
                id: box_parameters
                orientation: 'vertical'
                canvas.before:
                    Color:
                        rgb: hex("771C33")
                    Rectangle:
                        pos: self.pos
                        size: self.size
                BoxLayout:
                    id: box_parameters_inner
                    orientation: 'horizontal'
                    size_hint: (1.0,0.95)
                    FileChooserListView:
                        id: visualize_file_chooser_parameters
                        size_hint: (0.70,1.0)
                        filters: [root.file_allowed]
                        #canvas.before:
                        #    Color:
                        #        rgba: hex('#413FBF')
                        #    Rectangle:
                        #        pos: self.pos
                        #        size: self.size
                        on_selection: root.selected_file(*args)
                    RstDocument:
                        id: document_parameters_viewer
                GridLayout:
                    rows: 1
                    cols: 2
                    size_hint: (1.0,0.05)
                    Label:
                        id: current_path_parameters
                        valign: 'middle'
                        halign: 'center'
                    Button:
                        id: back_home_from_parameters
                        size_hint: (0.3,1.0)
                        on_press: root.go_to_home()
                        text: 'Come back to home'

        TabbedPanelItem:
            id: tabbed_reforms
            text: 'Reforms'
            on_release: root.show_reforms()
            background_color: (1, 0, 0, .5)
            BoxLayout:
                id: box_reforms
                orientation: 'vertical'
                canvas.before:
                    Color:
                        rgb: hex("771C33")
                    Rectangle:
                        pos: self.pos
                        size: self.size
                BoxLayout:
                    id: box_reforms_inner
                    orientation: 'horizontal'
                    size_hint: (1.0,0.95)
                    FileChooserListView:
                        id: visualize_file_chooser_reforms
                        size_hint: (0.70,1.0)
                        filters: [root.file_allowed]
                        #canvas.before:
                        #    Color:
                        #        rgba: hex('#413FBF')
                        #    Rectangle:
                        #        pos: self.pos
                        #        size: self.size
                        on_selection: root.selected_file(*args)
                    RstDocument:
                        id: document_reforms_viewer
                GridLayout:
                    rows: 1
                    cols: 2
                    size_hint: (1.0,0.05)
                    Label:
                        id: current_path_reforms
                        valign: 'middle'
                        halign: 'center'
                    Button:
                        id: back_home_from_parameters
                        size_hint: (0.3,1.0)
                        on_press: root.go_to_home()
                        text: 'Come back to home'


<MakeSimulation>:
    variable_added : variable_added
    name: "make_simulation"
    fullscreen: True

    BoxLayout:
        orientation: 'horizontal'
        BoxLayout:
            canvas.before:
                Color:
                    rgba: hex('#B48291')
                Rectangle:
                    pos: self.pos
                    size: self.size
            orientation: 'vertical'
            Label:
                text: 'Select [b]entity[/b]'
                halign: 'right'
                valign: 'top'
                markup: True
                size_hint: (1.0,0.095)
                canvas.before:
                    Color:
                        rgba: hex('#971640')
                    Rectangle:
                        pos: self.pos
                        size: self.size
            Label:
                size_hint: (1.0,0.05)

            Spinner:
                id: menu_a_tendina_entita
                size_hint: (0.8,0.1)
                pos_hint: {'center_x': .5, 'center_y': .5}
                on_text: root.update_form()

                text_size: self.width, None
                height: self.texture_size[1]
                padding_x: 10
            Label:
                size_hint: (1.0,0.05)

            Label:
                text: 'Select [b]input variable[/b]'
                halign: 'right'
                valign: 'top'
                markup: True
                size_hint: (1.0,0.07)
                canvas.before:
                    Color:
                        rgba: hex('#971640')
                    Rectangle:
                        pos: self.pos
                        size: self.size

            Label:
                size_hint: (1.0,0.05)
            Label:
                text: "Search Box (enter to search)"
                size_hint: (1.0,0.08)
            TextInput:
                id: id_search_box_input_variable
                size_hint: (0.8,0.1)
                hint_text: 'Insert a value to filter'
                multiline: False
                pos_hint: {'center_x': .5, 'center_y': .5}
                on_text_validate: root.change_spinner()
            Label:
                size_hint: (1.0,0.05)

            Spinner:
                id: menu_a_tendina_variabili
                size_hint: (0.8,0.15)
                pos_hint: {'center_x': .5, 'center_y': .5}

                text_size: self.width, None
                height: self.texture_size[1]
                padding_x: 10

            Label:
                size_hint: (1.0,0.05)
            TextInput:
                id: input_value_variable
                multiline: False
                hint_text: 'Insert a value'
                size_hint: (0.8,0.1)
                pos_hint: {'center_x': .5, 'center_y': .5}
            Label:
                size_hint: (1.0,0.05)
            Button:
                text: 'Add variable'
                size_hint: (0.5,0.05)
                pos_hint: {'center_x': .5, 'center_y': .5}
                on_press: root.add_value_and_reset_form()
                background_color: hex('B48291')
            Label:
                size_hint: (1.0,0.05)
            Label:
                id: information
                markup: True
                valign: 'center'
                text_size: self.width, None
                height: self.texture_size[1]
                padding_x: 50
            Button:
                text: 'Go to Output variable Screen'
                size_hint: (1.0,0.09)
                on_press: root.go_to_output_variables()
                background_color: hex('971640')

        BoxLayout:
            orientation: 'vertical'
            Label:
                text: 'Added variable(s)'
                halign: 'right'
                valign: 'top'
                size_hint: (1.0,0.05)
                canvas.before:
                    Color:
                        rgba: hex('#971640')
                    Rectangle:
                        pos: self.pos
                        size: self.size
            ScrollView:
                canvas.before:
                    Rectangle:
                        pos: self.pos
                        size: self.size
                do_scroll_x: False
                BoxLayout:
                    id: variable_added
                    orientation: 'vertical'
            Button:
                id: back_home
                size_hint: (1.0,0.05)
                on_press: root.go_to_home()
                text: 'Come back to home'
                background_color: hex('971640')


<OutputVariableScreen>:
    variable_added_output:variable_added_output
    name: "output_variable"
    fullscreen: True
    BoxLayout:
        orientation: 'horizontal'
        BoxLayout:
			canvas.before:
                Color:
                    rgba: hex('#B48291')
                Rectangle:
                    pos: self.pos
                    size: self.size
            orientation: 'vertical'
            Label:
                text: 'Select [b]entity[/b]'
                halign: 'right'
                valign: 'top'
                markup: True
                size_hint: (1.0,0.095)
                canvas.before:
                    Color:
                        rgba: hex('#971640')
                    Rectangle:
                        pos: self.pos
                        size: self.size
            Label:
                size_hint: (1.0,0.05)

            Spinner:
                id: menu_a_tendina_entita_output
                size_hint: (0.8,0.1)
                pos_hint: {'center_x': .5, 'center_y': .5}
                on_text: root.update_form()

                text_size: self.width, None
                height: self.texture_size[1]
                padding_x: 10
            Label:
                size_hint: (1.0,0.05)

            Label:
                text: 'Select [b]output variable[/b]'
                halign: 'right'
                valign: 'top'
                markup: True
                size_hint: (1.0,0.07)
                canvas.before:
                    Color:
                        rgba: hex('#971640')
                    Rectangle:
                        pos: self.pos
                        size: self.size

            Label:
                size_hint: (1.0,0.05)
            Label:
                text: "Search Box (enter to search)"
                size_hint: (1.0,0.08)
            TextInput:
                id: id_search_box_input_variable
                size_hint: (0.8,0.1)
                hint_text: 'Insert a value to filter'
                multiline: False
                pos_hint: {'center_x': .5, 'center_y': .5}
                on_text_validate: root.change_spinner()
            Label:
                size_hint: (1.0,0.05)

            Spinner:
                id: menu_a_tendina_variabili_output
                size_hint: (0.8,0.15)
                pos_hint: {'center_x': .5, 'center_y': .5}

                text_size: self.width, None
                height: self.texture_size[1]
                padding_x: 10

            Label:
                size_hint: (1.0,0.05)
            Button:
                text: 'Add variable'
                size_hint: (0.5,0.05)
                pos_hint: {'center_x': .5, 'center_y': .5}
                on_press: root.add_value_and_reset_form()

            Label:
                size_hint: (1.0,0.05)
            Label:
                id: information_output
                markup: True
                valign: 'center'
				text_size: self.width, None
                height: self.texture_size[1]
                padding_x: 50
            Button:
                text: 'Make Simulation!'
                size_hint: (1.0,0.085)
                on_press: root.go_to_execute_simulation()
				background_color: hex('971640')
        BoxLayout:
            id: boxlayout_addedvariables
            orientation: 'vertical'
            Label:
                text: 'Added variable(s)'
                halign: 'right'
                valign: 'top'
                size_hint: (1.0,0.05)
                canvas.before:
                    Color:
                        rgba: hex('#971640')
                    Rectangle:
                        pos: self.pos
                        size: self.size
            ScrollView:
                canvas.before:
                    Rectangle:
                        pos: self.pos
                        size: self.size
                do_scroll_x: False
                BoxLayout:
                    id: variable_added_output
                    orientation: 'vertical'
            GridLayout:
                cols:2
                rows:1
                size_hint: (1.0,0.05)
                Button:
                    id: back_home_02
                    size_hint: (0.5,0.05)
                    on_press: root.go_to_home()
                    text: 'Come back to home'
                    background_color: hex('971640')
                Button:
                    id: back_to_make_simulation
                    size_hint: (0.5,0.05)
                    on_press: root.go_to_make_simulation()
                    text: 'Come back to input variables'
                    background_color: hex('971640')



<ExecuteSimulationScreen>
    name: "execute_simulation"
    GridLayout:
        rows: 3
        cols: 1
        Label:
            text: "Summary of results for each situation"
            size_hint: (1.0,0.05)
            canvas.before:
                Color:
                    rgba: hex('#971640')
                Rectangle:
                    pos: self.pos
                    size: self.size
        RstDocument:
            id: document_results_simulation_viewer
            size_hint: (1.0,0.9)
        BoxLayout:
            orientation: "horizontal"
            size_hint: (1.0,0.05)
            Button:
                id: left_switch
                text: "Previous entity"
                on_press: root.previous_rst_result()
                background_color: hex('971640')
            Button:
                id: right_switch
                text: "Next entity"
                on_press: root.next_rst_result()
                background_color: hex('971640')
            Button:
                id: home_button
                text: "Go to home"
                on_press: root.go_to_home()
                background_color: hex('971640')

<LabelLeftTop>
    padding_x: 20
    halign: "left"
    valign: "top"
    text_size: self.size
    markup: True
    text: ""

<ConfirmPopup>:
    cols:1
	Label:
		text: root.text
	GridLayout:
		cols: 2
		size_hint_y: None
		height: '44sp'
		Button:
			text: 'Yes'
			on_press: root.dispatch('on_answer','Yes')
		Button:
			text: 'No'
			on_press: root.dispatch('on_answer', 'No')


<ErrorPopUp>:
    size_hint: 0.5,0.5
    title: "Some error"
    BoxLayout:
        orientation:'vertical'
        Label:
            id: label_error
            text_size: self.width, None
            halign: 'center'
            valign: 'middle'
            size_hint: (1.0,0.8)
        Button:
            text:"Close this popup"
            size_hint: (1.0,0.2)
            on_press:root.dismiss()